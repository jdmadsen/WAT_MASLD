---
title: "Fisher enrichment test of MASLD signature genes in subcluster markergenes, Adipocytes"
author: "Johanne D. Madsen"
format: html
editor: visual
---

```{r}
require(openxlsx)
library(clusterProfiler)
library(readxl)
library(org.Hs.eg.db)
library(tidytable)
library(purrr)
library(dplyr)
library(textshape)
library(pheatmap)
```

HA is ADH1B hi adipocytes, UHA is SFRP4 hi adipocytes

```{r}

HAMarkers <- read_excel("/work/without_ambientRNAremoval/data/HA_markers_final.xlsx")

UHAMarkers<-HAMarkers[HAMarkers$avg_log2FC<0,]
HAMarkers<-HAMarkers[HAMarkers$avg_log2FC>0,]


HAMarkers <- HAMarkers[order(HAMarkers$p_val_adj), ]
UHAMarkers <- UHAMarkers[order(UHAMarkers$p_val_adj), ]

HA_top_genes <- head(HAMarkers$gene, 200)

UHA_top_genes <- head(UHAMarkers$gene, 200)
```

```{r}
#Extracting full genesets for the top 5 GOterms for each signature

GOgenes_Ads_S1_ID <-ego_simplified_Ads_S1@geneSets[names(ego_simplified_Ads_S1@geneSets) %in% top5_Ads_S1$ID]

GOgenes_Ads_S1_ID_ordered<-GOgenes_Ads_S1_ID[top5_Ads_S1$ID]

names(GOgenes_Ads_S1_ID_ordered)<-top5_Ads_S1$Description

GOgenes_Ads_S1_list <- GOgenes_Ads_S1_ID_ordered

#

GOgenes_Ads_S23_ID <-ego_simplified_Ads_S23@geneSets[names(ego_simplified_Ads_S23@geneSets) %in% top5_Ads_S23$ID]

GOgenes_Ads_S23_ID_ordered<-GOgenes_Ads_S23_ID[top5_Ads_S23$ID]

names(GOgenes_Ads_S23_ID_ordered)<-top5_Ads_S23$Description

GOgenes_Ads_S23_list <- GOgenes_Ads_S23_ID_ordered

#

GOgenes_Ads_S3_ID <-ego_simplified_Ads_S3@geneSets[names(ego_simplified_Ads_S3@geneSets) %in% top5_Ads_S3$ID]

GOgenes_Ads_S3_ID_ordered<-GOgenes_Ads_S3_ID[top5_Ads_S3$ID]

names(GOgenes_Ads_S3_ID_ordered)<-top5_Ads_S3$Description

GOgenes_Ads_S3_list <- GOgenes_Ads_S3_ID_ordered

```

```{r}
#making a function to run Fisher enrichment test 

run_fisher_enrichment <- function(go_list, test_genes, background_genes) {
  results <- lapply(names(go_list), function(go_term) {
    go_genes <- go_list[[go_term]]
    # Ensure we're working within the background only
    go_genes <- intersect(go_genes, background_genes)
    test_genes_bg <- intersect(test_genes, background_genes)

    # Build contingency table
    A <- length(intersect(test_genes_bg, go_genes))
    B <- length(setdiff(test_genes_bg, go_genes))
    C <- length(setdiff(go_genes, test_genes_bg))
    D <- length(setdiff(background_genes, union(go_genes, test_genes_bg)))

    contingency <- matrix(c(A, B, C, D), nrow = 2, byrow = TRUE)
    ft <- fisher.test(contingency)

    data.frame(
      GO_term = go_term,
      p_value = ft$p.value,
      odds_ratio = ft$estimate,
      overlap = A,
      GO_size = length(go_genes),
      test_set_size = length(test_genes_bg),
      gene_ratio = A / length(go_genes)
    )
  })

  # Combine into a single data.frame and adjust p-values
  results_df <- do.call(rbind, results)
  results_df$adj_p_value <- p.adjust(results_df$p_value, method = "BH")
  results_df <- results_df[order(results_df$adj_p_value), ]
  return(results_df)
}

```

```{r}
gene_sets <- list(
  HA = HA_top_genes ,
  UHA = UHA_top_genes

)

go_lists <- list(
  Ads_S1 = GOgenes_Ads_S1_list,
  Ads_S23 = GOgenes_Ads_S23_list,
  Ads_S3 = GOgenes_Ads_S3_list
)

```

```{r}
all_results <- list()

for (Celltype in names(gene_sets)) {
  for (go_label in names(go_lists)) {
    result <- run_fisher_enrichment(go_lists[[go_label]], gene_sets[[Celltype]], background_list_adipocytes)
    result$Celltype <- Celltype
    result$GOsource <- go_label
    all_results[[paste(Celltype, go_label, sep = "_")]] <- result
  }
}

# Combine into one dataframe
combined_results <- do.call(rbind, all_results)

```

```{r, fig.width=10}
library(ggplot2)

combined_results
# Combine GO term order while tagging source

# Remove leading/trailing whitespace from GO term names
go_term_order <- c(
  paste0("Ads_S1__", trimws(names(GOgenes_Ads_S1_list))),
  paste0("Ads_S23__", trimws(names(GOgenes_Ads_S23_list))),
  paste0("Ads_S3__", trimws(names(GOgenes_Ads_S3_list)))
)


combined_results$GO_combined <- paste(combined_results$GOsource, combined_results$GO_term, sep = "__")

# Factor with correct order
combined_results$GO_combined <- factor(combined_results$GO_combined, levels = rev(go_term_order))

pdf("/work/without_ambientRNAremoval/figures/GO_Ads_signatures.pdf", width = 10, height=7)
ggplot(combined_results, aes(x = Celltype, y = GO_combined)) +
  geom_point(aes(size = gene_ratio, color = -log10(adj_p_value)))  +
  scale_color_gradientn(
    colors = c("white", "tomato", "firebrick"),
    values = scales::rescale(c(0, 2, max(-log10(combined_results$adj_p_value), na.rm = TRUE))),
    limits = c(0, max(-log10(combined_results$adj_p_value), na.rm = TRUE))
  )+
  theme_minimal() +
  labs(
    title = "GO Term Enrichment Dotplot",
    x = "",
    y = "GO Term",
    size = "Gene ratio",
    color = "-log10(adj_p_value)"
  )
dev.off()

```
